from CybORG import CybORG
from CybORG.Agents import SleepAgent, FiniteStateRedAgent, EnterpriseGreenAgent
from CybORG.Simulator.Scenarios import EnterpriseScenarioGenerator

aggressive_para = []
with open('default_para.txt', 'r') as file:
    lines = file.readlines()[3:]
    for line in lines:
        line = line.strip()
        if line:
            param_values = [float(value) for value in line.split(',')]
            aggressive_para.append(tuple(param_values))

hostname_ip_map={}
action_list = ['DiscoverRemoteSystems',
                'AggressiveServiceDiscovery',
                'StealthServiceDiscovery',
                'DiscoverDeception',
                'ExploitRemoteService',
                'PrivilegeEscalate',
                'Impact',
                'DegradeServices',
                'Withdraw']
filename = 'default_host_actions.txt'

steps = 500
ag_sg = EnterpriseScenarioGenerator(blue_agent_class=SleepAgent,
                                    green_agent_class=EnterpriseGreenAgent,
                                    red_agent_class=FiniteStateRedAgent,
                                    steps=steps,
                                    redParameters=aggressive_para,
                                    )
with open(filename, 'w') as file:
    # Initialise environment
    for epoch in range(1):
        cyborg = CybORG(scenario_generator=ag_sg)
        host_actions={}
        for i in range(steps):
            cyborg.step()
            step_actions = cyborg.environment_controller.action
            action=step_actions['red_agent_0'][0]
            if action.name=="Sleep":
                continue

            host_states = cyborg.environment_controller.agent_interfaces['red_agent_0'].agent.host_states
            for ip in host_states.keys():
                if host_states[ip]['hostname'] is not None and host_states[ip]['hostname'] not in hostname_ip_map:
                    hostname_ip_map[host_states[ip]['hostname']] = ip

            line = 'Action,' + action.name
            if action.name == 'DiscoverRemoteSystems':
                ip = action.subnet.with_prefixlen
                for ip in host_states:
                    if 'D' not in host_states[ip]['state']:
                        if ip not in host_actions:
                            host_actions[ip] = [action_list.index(action.name)]
                        else:
                            host_actions[ip].append(action_list.index(action.name))
                        continue
            elif hasattr(action, 'ip_address'):
                ip = action.ip_address.compressed
            else:
                ip = hostname_ip_map[action.hostname]
            if ip not in host_actions:
                host_actions[ip]=[action_list.index(action.name)]
            else:
                host_actions[ip].append(action_list.index(action.name))
        for actions in host_actions.values():
            for action in actions:
                file.write(str(action))
            file.write('\n')
